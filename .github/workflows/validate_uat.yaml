on:
  push:
    branches:
      - UAT_Validate

jobs:
  validate_uat:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1ï¸âƒ£ Checkout repo
      # =========================
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================
      # 2ï¸âƒ£ Setup environment
      # =========================
      - name: Setup Node.js and SF CLI
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: |
          sudo apt-get update && sudo apt-get install -y unzip curl openjdk-17-jdk
          npm install --global @salesforce/cli
          echo "y" | sf plugins:install sfdx-git-delta

      # =========================
      # 3ï¸âƒ£ Restore last depth cache (fixed version)
      # =========================
      - name: Restore last depth cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .last_depth
          key: depth-${{ github.ref }}-${{ github.run_id }}
          restore-keys: |
            depth-${{ github.ref }}-
        continue-on-error: true

      - name: Read last depth
        id: read-depth
        run: |
          if [ -f ".last_depth" ]; then
            DEPTH=$(cat .last_depth)
          else
            DEPTH=${{ vars.DEFAULT_VALUE_DEPTH }}
          fi
          echo "DEPTH=$DEPTH" >> $GITHUB_ENV
          echo "ğŸ“˜ Current commit depth: $DEPTH"

      # =========================
      # 4ï¸âƒ£ Prepare commit range
      # =========================
      - name: Prepare commit range
        id: commits
        run: |
          FROM_COMMIT=$(git rev-parse HEAD~$DEPTH)
          TO_COMMIT="${{ github.sha }}"

          echo "FROM_COMMIT=$FROM_COMMIT" >> $GITHUB_ENV
          echo "TO_COMMIT=$TO_COMMIT" >> $GITHUB_ENV
          echo "ğŸ” Using commit range: $FROM_COMMIT â†’ $TO_COMMIT"

      # =========================
      # 5ï¸âƒ£ Salesforce Authentication
      # =========================
      - name: Authenticate Salesforce
        run: |
            sf org login jwt \
            --client-id ${{ secrets.ASWT_CONSUMER_KEY_UAT }} \
            --jwt-key-file aswt_uat_server.key \
            --username ${{ vars.ASWT_USERNAME_UAT }} \
            --instance-url ${{ vars.ASWT_URL_UAT }} \
            --alias uat

      # =========================
      # 6ï¸âƒ£ Generate Delta Package
      # =========================
      - name: Generate Delta Package
        run: |
          if [ -z "$FROM_COMMIT" ]; then
            echo "âš ï¸ FROM_COMMIT not set, skipping delta package"
            exit 0
          fi

          sfdx sgd:source:delta \
            --from "$FROM_COMMIT" \
            --to "$TO_COMMIT" \
            --output-dir . \
            --ignore-file .gitignore

          cat package/package.xml || echo "âš ï¸ No package.xml generated"

      # =========================
      # 7ï¸âƒ£ Validate Deployment (with accurate result detection)
      # =========================
      - name: Validate Deployment
        id: validate
        run: |
          if [ ! -f "package/package.xml" ]; then
            echo "âœ… No changes to deploy"
            echo "RESULT=success" >> $GITHUB_ENV
            exit 0
          fi

          echo "ğŸ” Detecting test classes..."
          APEX_CLASSES=$(yq -p=xml -o=json . < package/package.xml | jq -r \
            '.Package.types | [.] | flatten | map(select(.name == "ApexClass")) | 
             .[] | .members | [.] | flatten | 
             map(select((index("*") | not) and (test("Test|Tes")))) | unique | join(" ")')

          echo "APEX_CLASSES=$APEX_CLASSES"

          echo "ğŸš€ Starting validation..."
          if [ -z "$APEX_CLASSES" ]; then
            sfdx project deploy start -c -x package/package.xml --dry-run --wait 1200 -o uat --verbose
            DEPLOY_EXIT=$?
          else
            sfdx project deploy start -c -x package/package.xml --dry-run --wait 1200 --verbose -g -l RunSpecifiedTests --tests $APEX_CLASSES -o uat
            DEPLOY_EXIT=$?
          fi

          echo "ğŸ”¢ DEPLOY_EXIT=$DEPLOY_EXIT"

          if [ $DEPLOY_EXIT -eq 0 ]; then
            echo "âœ… Validation succeeded"
            echo "RESULT=success" >> $GITHUB_ENV
          else
            echo "âŒ Validation failed"
            echo "RESULT=fail" >> $GITHUB_ENV
          fi

      # =========================
      # 8ï¸âƒ£ Save depth state (auto increase when failed)
      # =========================
      - name: Save depth state
        if: always()
        run: |
          DEPTH=${DEPTH:-1}
          RESULT=${RESULT:-fail}

          if [ "$RESULT" = "success" ]; then
            echo "1" > .last_depth
            echo "ğŸŸ¢ Reset depth to 1 (validation succeeded)"
          else
            NEW_DEPTH=$((DEPTH+1))
            if [ $NEW_DEPTH -gt ${{ vars.MAX_DEPTH }} ]; then
              NEW_DEPTH=${{ vars.MAX_DEPTH }}
            fi
            echo "$NEW_DEPTH" > .last_depth
            echo "âš ï¸ Increased depth to $NEW_DEPTH for next run"
          fi

      # =========================
      # 9ï¸âƒ£ Debug info (optional but recommended)
      # =========================
      - name: Debug cache info
        if: always()
        run: |
          echo "ğŸ”¹ Branch: ${{ github.ref }}"
          echo "ğŸ”¹ Result: $RESULT"
          echo "ğŸ”¹ Depth before: $DEPTH"
          echo "ğŸ”¹ Cache key to be saved: depth-${{ github.ref }}-${{ github.run_id }}"

      # =========================
      # ğŸ”Ÿ Save depth cache (safe overwrite)
      # =========================
      - name: Save depth cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .last_depth
          key: depth-${{ github.ref }}-${{ github.run_id }}
          enableCrossOsArchive: false