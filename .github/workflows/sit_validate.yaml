on:
  push:
    branches:
      - Github_SIT_Validate

jobs:
  validate_sit:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1Ô∏è‚É£ Checkout repo
      # =========================
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================
      # 2Ô∏è‚É£ Setup environment
      # =========================
      - name: Setup Node.js and SF CLI
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: |
          sudo apt-get update && sudo apt-get install -y unzip curl openjdk-17-jdk
          npm install --global @salesforce/cli
          echo "y" | sf plugins:install sfdx-git-delta

      # =========================
      # 3Ô∏è‚É£ Restore last depth cache (fixed version)
      # =========================
      - name: Restore last depth cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .last_depth
          key: depth-${{ github.ref }}-${{ github.run_id }}
          restore-keys: |
            depth-${{ github.ref }}-
        continue-on-error: true

      - name: Read last depth
        id: read-depth
        run: |
          if [ -f ".last_depth" ]; then
            DEPTH=$(cat .last_depth)
          else
            DEPTH=${{ vars.DEFAULT_VALUE_DEPTH }}
          fi
          echo "DEPTH=$DEPTH" >> $GITHUB_ENV
          echo "üìò Current commit depth: $DEPTH"

      # =========================
      # 4Ô∏è‚É£ Prepare commit range
      # =========================
      - name: Prepare commit range
        id: commits
        run: |
          FROM_COMMIT=$(git rev-parse HEAD~$DEPTH)
          TO_COMMIT="${{ github.sha }}"

          echo "FROM_COMMIT=$FROM_COMMIT" >> $GITHUB_ENV
          echo "TO_COMMIT=$TO_COMMIT" >> $GITHUB_ENV
          echo "üîç Using commit range: $FROM_COMMIT ‚Üí $TO_COMMIT"

      # =========================
      # 5Ô∏è‚É£ Salesforce Authentication
      # =========================
      - name: Authenticate Salesforce
        run: |
            sf org login jwt \
            --client-id ${{ secrets.ASWT_CONSUMER_KEY_SIT }} \
            --jwt-key-file aswt_sit_server.key \
            --username ${{ vars.ASWT_USERNAME_SIT }} \
            --instance-url ${{ vars.ASWT_URL_SIT }} \
            --alias sit

      # =========================
      # 6Ô∏è‚É£ Generate Delta Package
      # =========================
      - name: Generate Delta Package
        run: |
          if [ -z "$FROM_COMMIT" ]; then
            echo "‚ö†Ô∏è FROM_COMMIT not set, skipping delta package"
            exit 0
          fi

          sfdx sgd:source:delta \
            --from "$FROM_COMMIT" \
            --to "$TO_COMMIT" \
            --output-dir . \
            --ignore-file .gitignore

          cat package/package.xml || echo "‚ö†Ô∏è No package.xml generated"

      # =========================
      # 7Ô∏è‚É£ Validate Deployment (with accurate result detection)
      # =========================
      - name: Validate Deployment
        id: validate
        run: |
          if [ ! -f "package/package.xml" ]; then
            echo "‚úÖ No changes to deploy"
            echo "RESULT=success" >> $GITHUB_ENV
            exit 0
          fi

          echo "üîç Detecting test classes..."
          APEX_CLASSES=$(yq -p=xml -o=json . < package/package.xml | jq -r \
            '.Package.types | [.] | flatten | map(select(.name == "ApexClass")) | 
             .[] | .members | [.] | flatten | 
             map(select((index("*") | not) and (test("Test|Tes")))) | unique | join(" ")')

          echo "APEX_CLASSES=$APEX_CLASSES"

          echo "üöÄ Starting validation..."
          if [ -z "$APEX_CLASSES" ]; then
            sf project deploy start --dry-run --manifest package/package.xml --wait 100 --target-org sit --verbose
            DEPLOY_EXIT=$?
          else
            sf project deploy start --dry-run --manifest package/package.xml --wait 100 --target-org sit --verbose -l RunLocalTests
            DEPLOY_EXIT=$?
          fi

          echo "üî¢ DEPLOY_EXIT=$DEPLOY_EXIT"

          if [ $DEPLOY_EXIT -eq 0 ]; then
            echo "‚úÖ Validation succeeded"
            echo "RESULT=success" >> $GITHUB_ENV
          else
            echo "‚ùå Validation failed"
            echo "RESULT=fail" >> $GITHUB_ENV
          fi

      # =========================
      # 8Ô∏è‚É£ Save depth state (auto increase when failed)
      # =========================
      - name: Save depth state
        if: always()
        run: |
          DEPTH=${DEPTH:-1}
          RESULT=${RESULT:-fail}

          if [ "$RESULT" = "success" ]; then
            echo "1" > .last_depth
            echo "üü¢ Reset depth to 1 (validation succeeded)"
          else
            NEW_DEPTH=$((DEPTH+1))
            if [ $NEW_DEPTH -gt ${{ vars.MAX_DEPTH }} ]; then
              NEW_DEPTH=${{ vars.MAX_DEPTH }}
            fi
            echo "$NEW_DEPTH" > .last_depth
            echo "‚ö†Ô∏è Increased depth to $NEW_DEPTH for next run"
          fi

      # =========================
      # 9Ô∏è‚É£ Debug info (optional but recommended)
      # =========================
      - name: Debug cache info
        if: always()
        run: |
          echo "üîπ Branch: ${{ github.ref }}"
          echo "üîπ Result: $RESULT"
          echo "üîπ Depth before: $DEPTH"
          echo "üîπ Cache key to be saved: depth-${{ github.ref }}-${{ github.run_id }}"

      # =========================
      # üîü Save depth cache (safe overwrite)
      # =========================
      - name: Save depth cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .last_depth
          key: depth-${{ github.ref }}-${{ github.run_id }}
          enableCrossOsArchive: false

      # =========================
      # 1Ô∏è‚É£1Ô∏è‚É£ Extract Validation Output to CSV
      # =========================
      - name: Extract validation result to CSV
        if: always()
        run: |
          LOG_FILE="validate_output.log"
          CSV_FILE="validation_result.csv"

          # Ambil output step sebelumnya (Validate Deployment)
          echo "üîç Extracting validation errors..."
          tail -n 2000 $GITHUB_WORKSPACE/_temp/_runner_file_commands/* > $LOG_FILE 2>/dev/null || true
          if [ ! -s "$LOG_FILE" ]; then
            echo "‚ö†Ô∏è No validation log found, generating empty CSV."
            echo "Type,Name,Problem,LineColumn" > "$CSV_FILE"
            exit 0
          fi

          # Cari baris yang mirip dengan tabel error Salesforce
          grep -E "ApexClass|ApexTrigger|ApexComponent|LightningComponent" "$LOG_FILE" | \
            awk 'BEGIN { FS=" {2,}"; OFS=","; print "Type,Name,Problem,LineColumn" } 
                 { gsub(/^ +| +$/, ""); if (NF>=3) print $1,$2,$3,$4 }' > "$CSV_FILE"

          echo "üìù Extracted validation results to $CSV_FILE"

      # =========================
      # 1Ô∏è‚É£2Ô∏è‚É£ Upload CSV artifact
      # =========================
      - name: Upload validation CSV
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation_result
          path: validation_result.csv

