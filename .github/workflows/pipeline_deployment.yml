name: Deploy to Salesforce

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y unzip curl openjdk-17-jdk
          npm install --global @salesforce/cli
          echo "y" | sf plugins:install sfdx-git-delta

      - name: Authenticate Salesforce
        run: |
          sf org login jwt \
            --client-id ${{ secrets.CONSUMER_KEY }} \
            --jwt-key-file server.key \
            --username ${{ vars.USERNAME }} \
            --instance-url ${{ vars.URL_INSTANCE }} \
            --alias My_Trailhead

      - name: Generate Delta Package
        run: |
          export FROM_COMMIT=${{ github.event.before }}
          #sfdx sgd:source:delta --from "$FROM_COMMIT" --output . --ignore .gitignore
          sfdx sgd:source:delta --from "$FROM_COMMIT" --to HEAD --output-dir . --ignore-file .gitignore
          cat package/package.xml || echo "No package.xml generated"

      - name: Deploy to Salesforce
        run: |
          if [ ! -f "package/package.xml" ]; then
            echo "No changes to deploy"
            exit 0
          fi

          APEX_CLASSES=$(yq -p=xml -o=json . < package/package.xml | jq -r '.Package.types | [.] | flatten | map(select(.name == "ApexClass")) | .[] | .members | [.] | flatten | map(select((index("*") | not) and (test("Test|Tes")))) | unique | join(" ")')

          if [ -z "$APEX_CLASSES" ]; then
            echo "No Apex test classes found, deploying with check-only"
            sf project deploy start -c -x package/package.xml --wait 40 --target-org My_Trailhead --verbose
          else
            echo "Running tests: $APEX_CLASSES"
            sf project deploy start -c -x package/package.xml --wait 40 --target-org My_Trailhead --verbose -l RunSpecifiedTests --tests $APEX_CLASSES
          fi
