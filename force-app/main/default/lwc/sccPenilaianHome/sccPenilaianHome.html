<!--
  @description       : 
  @author            : Christian Vieri
  @group             : 
  @last modified on  : 11-07-2025
  @last modified by  : Christian Vieri
-->
<template>
    <lightning-card>
        <div class="slds-p-around_medium">
            <div class="slds-grid slds-wrap slds-gutters">
                <template if:true={fieldVisibility.showNamaAgent}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small slds-text-align_left" style="position: relative;">
                        <lightning-input 
                            type="text" 
                            label="Cari Nama Agent" 
                            value={searchKeyword} 
                            onchange={handleSearchChange}
                            data-exclude="true">
                        </lightning-input>
                        <template if:true={isDropdownOpen}>
                            <div class="custom-dropdown slds-text-align_left">
                                <div class="dropdown-header">
                                    <button class="close-button" onclick={closeDropdown} title="Tutup Pencarian">
                                        <lightning-icon icon-name="utility:close" size="small" class="icon-close"></lightning-icon>
                                    </button>
                                </div>
                                <ul class="dropdown-list">
                                    <template for:each={searchResults} for:item="result">
                                        <li key={result.Id} class="dropdown-item">
                                            <button class="slds-button dropdown-button" data-id={result.Id} data-name={result.Name} onclick={handleSelect}>{result.Name}</button>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    </div>
                </template>
                <template if:true={fieldVisibility.showNamaAgent}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input  type="text"  label="Agent Id"  name="AgentId" value={selectedAgentId}  style="display:none;"  disabled>
                        </lightning-input>
                        <lightning-input  type="text"  label="Nama Agent Terpilih"  name = 'namaAgent' value={selectedAgentName} required disabled>
                        </lightning-input>
                    </div>
                </template> 
                
                <!-- No Tiket Bricare -->
                <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                    <lightning-input type="text" label="No Tiket Bricare" name ={noTiketBricare} value={caseData.CaseNumber} disabled="true"></lightning-input>
                </div>

                <!-- Nama Nasabah -->
                <template if:true={fieldVisibility.showNamaNasabah}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Nama Nasabah" name ={namaNasabah} value={caseData.Account.Name} disabled="true"></lightning-input>
                    </div>
                </template>

                <!-- Nomor Kartu -->
                <template if:true={fieldVisibility.showNomorKartu}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Nomor Kartu" name ={nomorKartu} value={caseData.SCC_Card_Number__c} disabled="true"></lightning-input>
                    </div>
                </template>

                <!-- Nomor Rekening -->
                <template if:true={fieldVisibility.showNomorRekening}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Nomor Rekening" name ={nomorRekening} value={caseData.SCC_Account_Number__c}  disabled="true"></lightning-input>
                    </div>
                </template>

                <!-- Nomor Ponsel / Telepon -->
                <template if:true={fieldVisibility.showNomorPonsel}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Nomor Ponsel / Telepon" name ={nomorPonsel} value={caseData.Cust_Current_Phone__c}  disabled="true"></lightning-input>
                    </div>
                </template>

                <!-- Ext Avaya /  ID Login -->
                <template if:true={fieldVisibility.showExtAvaya}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Ext Avaya / ID Login" name="extAvayaIdLogin" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

                <!-- Durasi Percakapan -->
                <template if:true={fieldVisibility.showDurasi}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Durasi Percakapan" name="durasiPercakapan" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

                <!-- Waktu Interaksi -->
                <template if:true={fieldVisibility.showWaktuInteraksi}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Waktu Interaksi" name="waktuInteraksi" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

                <!-- Tanggal Callmon -->
                <template if:true={fieldVisibility.showTanggalCallmon}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="date" label="Tanggal Callmon" name="tanggalCallmon" onchange={handleInputChange} required></lightning-input>
                    </div>
                </template>

                <!-- Calltype -->
                <template if:true={fieldVisibility.showCalltype}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Calltype" name="calltype" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

                <!-- Perihal -->
                <template if:true={fieldVisibility.showPerihal}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Perihal" name="perihal" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

                <!-- Nama QA -->
                <template if:true={fieldVisibility.showNamaQA}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <!-- <lightning-input type="text" label="Nama QA" name="namaQA" onchange={handleInputChange}></lightning-input> -->
                        <lightning-input type="text" label="Nama QA" name="namaQA" value={userName} disabled></lightning-input>
                    </div>
                </template>

                <!-- Inisial Agent -->
                <template if:true={fieldVisibility.showInisialAgent}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Inisial Agent" name="inisialAgent" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

                <!-- Channel -->
                <template if:true={fieldVisibility.showChannel}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Channel" name="channel" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

                <!-- Tanggal Interaksi -->
                <template if:true={fieldVisibility.showTanggalInteraksi}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="date" label="Tanggal Interaksi" name="tanggalInteraksi" onchange={handleInputChange} required></lightning-input>
                    </div>
                </template>

                <!-- Respon Jawab -->
                <template if:true={fieldVisibility.showResponJawab}>
                    <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                        <lightning-input type="text" label="Respon Jawab" name="responJawab" onchange={handleInputChange}></lightning-input>
                    </div>
                </template>

            </div>
        </div>
        
        <div class="slds-p-around_medium" style="border: 1px solid #00529c; border-radius: 5px; padding: 16px; background-color:#00529c">
            <!-- Table Header -->
            <table class="slds-table slds-table_bordered">
                <thead >
                    <tr>
                        <th class="slds-text-align_center">Aspek Penilaian</th>
                        <th class="slds-text-align_center">Bobot %</th>
                        <th class="slds-text-align_center">Hasil</th>
                        <th class="slds-text-align_center">Skor</th>
                        <th class="slds-text-align_center">Finding</th>
                        <th class="slds-text-align_center">Keterangan Penilaian QA</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Iterate over groupedData and create section headers and rows for each section -->
                    <template for:each={groupedData} for:item="sectionData">
                        <!-- Section Header with Inline Styles -->
                        <template if:false={agentLeaderView}>
                            <tr key={sectionData.section} style="background-color: #f4f6f9; font-weight: bold; color: #1d3557;">
                                <td colspan="6" class="slds-text-align_left slds-size_1-of-1 slds-text-heading_small" style="border-top: 2px solid #c9c9c9; border-right: 2px solid #c9c9c9;border-left: 1px solid #c9c9c9">
                                    {sectionData.section}
                                </td>
                            </tr>
                        </template>
                        <!-- Section For Agent Leader -->
                        <template if:true={agentLeaderView}>
                            <tr key={sectionData.section} style="background-color: #f4f6f9; font-weight: bold; color: #1d3557;">
                                <td colspan="1" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;">{sectionData.section}</td>
                                <td colspan="1" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;">{sectionData.bobot}</td>
                                <td colspan="1" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;"></td>
                                <td colspan="1" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;">
                                    <template if:true={sectionData.bobot}>
                                        {sectionData.sectionScore}
                                    </template>
                                </td>
                                <td colspan="2" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;"></td>
                            </tr>
                        </template>
                        <!-- Section Rows -->
                        <template for:each={sectionData.rows} for:item="row">
                            <tr key={row.Id}>
                                <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;border-left: 1px solid #c9c9c9" hidden>{row.Id}</td>
                                <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;border-left: 1px solid #c9c9c9">{row.Name}</td>
                                <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;">{row.Bobot__c}</td>
                                <!-- Hasil input for user to enter -->
                                <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;">
                                    <input value={row.Hasil} data-id={row.Id} onchange={handleHasilChange} 
                                           style="border: none; outline: none; background-color: transparent; text-align: center; padding: 0;"/>
                                </td>
                                <!-- Skor will be calculated based on Hasil x Bobot -->
                                <template if:false={agentLeaderView}>
                                    <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{row.Skor}</td>
                                </template> 
                                <template if:true={agentLeaderView}>
                                    <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">
                                        <template if:false={sectionData.bobot}>
                                            {row.Skor}
                                        </template>
                                        <template if:true={sectionData.bobot}>
                                            <!-- Kosongkan sel jika sectionData.bobot adalah true -->
                                        </template>
                                    </td>
                                </template>
                                <!-- <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{row.Finding__c}</td> -->
                                <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">
                                    <select value={row.Finding__c} data-id={row.Id} onchange={handleFindingChange} 
                                        style="width: 150px; height: 30px; border: 1px solid #ccc; border-radius: 4px; padding: 2px;">
                                        <option value="">--Select--</option>
                                        <template if:true={row.picklist} for:each={row.picklist} for:item="option">
                                            <option key={option.value} value={option.value}>{option.label}</option>
                                        </template>
                                        <template if:false={row.picklist}>
                                            <option value="">No options available</option>
                                        </template>
                                    </select>
                                </td>                   
                                <!-- Keterangan Penilaian QA input for user to enter -->
                                <td class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;">
                                    <input value={row.Keterangan_Penilaian_QA__c} data-id={row.Id} onchange={handleKeteranganChange}
                                        style="border: none; outline: none; background-color: transparent; text-align: center; padding: 0;" />
                                </td>
                                
                            </tr>
                        </template>
                    </template>
                </tbody>
                <!-- Total Critical and Non-Critical Errors with Average -->
                <tr style="background-color: #f4f6f9; font-weight: bold; color: #1d3557;">
                    <td colspan="1" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;border-left: 1px solid #c9c9c9">Total Critical Error</td>
                    <td colspan="3" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{totalCriticalError}</td>
                    <!-- <td colspan="2" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{averageCriticalError}</td> -->
                    <td colspan="2" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{countCriticalZero}</td>
                </tr>
                <tr style="background-color: #f4f6f9; font-weight: bold; color: #1d3557;">
                    <td colspan="1" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;border-left: 1px solid #c9c9c9">Total Non-Critical Error</td>
                    <td colspan="3" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{totalNonCriticalError}</td>
                    <!-- <td colspan="2" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{averageNonCriticalError}</td> -->
                    <td colspan="2" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{countNonCriticalZero}</td>
                </tr>
                <tr style="background-color: #f4f6f9; font-weight: bold; color: #1d3557;">
                    <td colspan="2" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9;border-left: 1px solid #c9c9c9">Total Penilaian</td>
                    <td colspan="4" class="slds-text-align_center" style="border-right: 1px solid #c9c9c9">{totalUtama}</td>
                </tr>
            </table>
        </div>
        <div class="slds-text-align_center slds-m-top_medium">
            <lightning-button label="Submit" variant="brand" class="slds-m-top_medium" onclick={openModal}></lightning-button>
        </div>
        <template if:true={isModalOpen}>
            <section class="slds-modal slds-fade-in-open" style="border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);">
                <div class="slds-modal__container" style="border-radius: 10px;">
                    <!-- Header -->
                    <header class="slds-modal__header" style="background-color: #f4f6f9; border-radius: 10px 10px 0 0; text-align: center; padding: 16px;">
                        <h2 class="slds-text-heading_medium" style="color: #333; font-weight: bold;">
                            <lightning-icon icon-name="utility:info" size="small" style="margin-right: 8px;"></lightning-icon>
                            Konfirmasi Simpan Data
                        </h2>
                    </header>
        
                    <!-- Content -->
                    <div class="slds-modal__content slds-p-around_medium" style="font-size: 16px; text-align: center; color: #555;">
                        <p>Apakah Anda yakin ingin menyimpan data ini?</p>
                    </div>
        
                    <!-- Footer -->
                    <footer class="slds-modal__footer" style="background-color: #f9f9f9; border-radius: 0 0 10px 10px; text-align: center; padding: 16px;">
                        <lightning-button 
                            label="Tidak" 
                            onclick={closeModal} 
                            variant="neutral" 
                            class="slds-m-right_small" 
                            style="border-radius: 8px;">
                        </lightning-button>
                        <lightning-button 
                            label="Ya" 
                            onclick={handleSaveData} 
                            variant="brand" 
                            style="border-radius: 8px; background-color: #00529c; border: none;"
                            disabled={isSaving}>
                        </lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>   
    </lightning-card>
</template>