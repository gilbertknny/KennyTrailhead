<!--
  @description       : 
  @author            : ChangeMeIn@UserSettingsUnder.SFDoc
  @group             : 
  @last modified on  : 08-15-2025
  @last modified by  : ChangeMeIn@UserSettingsUnder.SFDoc
-->
<template>
    <lightning-card title="CSV Upload Manager" icon-name="utility:upload">
        <div class="slds-p-horizontal_small">
            <!-- Template Selection Section -->
            <div class="slds-section slds-is-open">
                <h3 class="slds-section__title slds-theme_shade">
                    <span class="slds-truncate slds-p-horizontal_small" title="Template Selection">
                        Step 1: Select Template
                    </span>
                </h3>
                <div class="slds-section__content slds-p-around_small">
                    <div class="slds-form-element">
                        <label class="slds-form-element__label" for="template-select">
                            Choose CSV Template
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-combobox
                                name="template-select"
                                placeholder="Select a template..."
                                options={templateOptions}
                                value={selectedTemplateId}
                                onchange={handleTemplateChange}>
                            </lightning-combobox>
                        </div>
                    </div>
                    
                    <!-- Template Info -->
                    <template if:true={selectedTemplate}>
                        <div class="slds-box slds-theme_shade slds-m-top_small">
                            <p><strong>Template:</strong> {selectedTemplate.label}</p>
                            <p><strong>Case Type:</strong> {selectedTemplate.caseType}</p>
                            <p><strong>Expected Fields:</strong> {selectedTemplate.fieldNames}</p>
                        </div>
                    </template>
                    
                    <!-- Download Template Button -->
                    <template if:true={selectedTemplateId}>
                        <div class="slds-m-top_small">
                            <lightning-button
                                variant="brand-outline"
                                label="Download Template"
                                icon-name="utility:download"
                                onclick={handleDownloadTemplate}>
                            </lightning-button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- File Upload Section -->
            <div class="slds-section slds-is-open slds-m-top_medium">
                <h3 class="slds-section__title slds-theme_shade">
                    <span class="slds-truncate slds-p-horizontal_small" title="File Upload">
                        Step 2: Upload CSV File
                    </span>
                </h3>
                <div class="slds-section__content slds-p-around_small">
                    <lightning-file-upload
                        label="Upload CSV File"
                        name="csvFile"
                        accept=".csv"
                        record-id=""
                        onuploadfinished={handleUploadFinished}
                        multiple="false">
                    </lightning-file-upload>
                    
                    <!-- Manual File Input Alternative -->
                    <div class="slds-m-top_small">
                        <label class="slds-form-element__label" for="file-input">
                            Or select file manually:
                        </label>
                        <input
                            type="file"
                            id="file-input"
                            accept=".csv"
                            onchange={handleFileChange}
                            class="slds-file-selector__input slds-assistive-text">
                        <label class="slds-file-selector__body" for="file-input">
                            <span class="slds-file-selector__button slds-button slds-button_neutral">
                                <lightning-icon icon-name="utility:upload" alternative-text="Upload" size="x-small"></lightning-icon>
                                Choose File
                            </span>
                            <span class="slds-file-selector__text slds-medium-show">
                                {fileName}
                            </span>
                        </label>
                    </div>
                    
                    <!-- Upload Button -->
                    <template if:true={fileContent}>
                        <div class="slds-m-top_small">
                            <lightning-button
                                variant="brand"
                                label="Preview & Upload"
                                icon-name="utility:preview"
                                onclick={handleUploadClick}
                                disabled={isProcessing}>
                            </lightning-button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Loading Spinner -->
            <template if:true={isProcessing}>
                <div class="slds-m-top_medium slds-text-align_center">
                    <lightning-spinner alternative-text="Processing..." size="medium"></lightning-spinner>
                </div>
            </template>

            <!-- Preview Section -->
            <template if:true={previewData}>
                <div class="slds-section slds-is-open slds-m-top_medium">
                    <h3 class="slds-section__title slds-theme_shade">
                        <span class="slds-truncate slds-p-horizontal_small" title="Data Preview">
                            Step 3: Data Preview
                        </span>
                    </h3>
                    <div class="slds-section__content slds-p-around_small">
                        <div class="slds-box slds-theme_info slds-m-bottom_small">
                            <p><strong>Total Rows:</strong> {previewData.totalRows}</p>
                            <p><strong>Case Type:</strong> {previewData.caseType}</p>
                            <p><strong>Status:</strong> {previewData.message}</p>
                        </div>
                        
                        <!-- Data Table -->
                        <template if:true={previewData.success}>
                            <div class="slds-scrollable_x">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                            <template for:each={previewData.headers} for:item="header">
                                                <th key={header} class="slds-text-title_caps" scope="col">
                                                    <div class="slds-truncate" title={header}>{header}</div>
                                                </th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={previewDataWithKeys} for:item="row">
                                            <tr key={row.id} class="slds-hint-parent">
                                                <template for:each={row.cells} for:item="cell">
                                                    <td key={cell.id} class="slds-text-body_small">
                                                        <div class="slds-truncate" title={cell.value}>{cell.value}</div>
                                                    </td>
                                                </template>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Process Button -->
                            <div class="slds-m-top_small slds-text-align_center">
                                <lightning-button
                                    variant="success"
                                    label="Process & Create Cases"
                                    icon-name="utility:check"
                                    onclick={handleProcessData}
                                    disabled={isProcessing}>
                                </lightning-button>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Results Section -->
            <template if:true={processResult}>
                <div class="slds-section slds-is-open slds-m-top_medium">
                    <h3 class="slds-section__title slds-theme_shade">
                        <span class="slds-truncate slds-p-horizontal_small" title="Process Results">
                            Process Results
                        </span>
                    </h3>
                    <div class="slds-section__content slds-p-around_small">
                        <template if:true={processResult.success}>
                            <div class="slds-box slds-theme_success">
                                <lightning-icon icon-name="utility:success" size="small" class="slds-m-right_small"></lightning-icon>
                                <strong>Success!</strong> {processResult.message}
                                <br>Records Processed: {processResult.recordsProcessed}
                            </div>
                        </template>
                        
                        <template if:false={processResult.success}>
                            <div class="slds-box slds-theme_error">
                                <lightning-icon icon-name="utility:error" size="small" class="slds-m-right_small"></lightning-icon>
                                <strong>Error:</strong> {processResult.message}
                            </div>
                            
                            <template if:true={hasErrors}>
                                <div class="slds-m-top_small">
                                    <h4 class="slds-text-heading_small">Error Details:</h4>
                                    <ul class="slds-list_dotted">
                                        <template for:each={processResult.errors} for:item="error">
                                            <li key={error} class="slds-text-color_error">{error}</li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </template>
                        
                        <!-- Reset Button -->
                        <div class="slds-m-top_small">
                            <lightning-button
                                variant="neutral"
                                label="Start Over"
                                icon-name="utility:refresh"
                                onclick={handleReset}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </lightning-card>
</template>