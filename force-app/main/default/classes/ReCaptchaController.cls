/**
 * @description       : Controller class for validating Google reCAPTCHA tokens using a Named Credential callout.
 * @author            : Ishardan
 * @createdDate       : 16/10/2025
 * @lastModifiedBy    : Ishardan
 * @lastModifiedDate  : 17/10/2025
 * @groupDescription  : Handles server-side verification of Google reCAPTCHA tokens to prevent automated bot submissions.
 */

public with sharing class ReCaptchaController{
        /**
                 * @description  Validates the provided reCAPTCHA token by sending a callout to the Google reCAPTCHA verification endpoint.
                 * @param token  The reCAPTCHA token received from the client-side (generated by Google reCAPTCHA v3).
                 * @return       A Map<String, Object> containing the response from Google reCAPTCHA API, including the success flag and optional error codes.
                 * @throws       AuraHandledException if the token is missing or if the callout to Google's API fails.
                 *
                 * Example response structure:
                 * {
                 *   "success": true,
                 *   "challenge_ts": "2025-10-17T08:00:00Z",
                 *   "hostname": " ptasuransiwahanatata--sb1.sandbox.lightning.force.com",
                 *   "score": 0.9,
                 *   "action": "submit"
                 * }
                 */
@AuraEnabled
    public static Map<String, Object> isReCaptchaValid(String token) {

        if (String.isBlank(token)) {
            throw new AuraHandledException('Missing reCAPTCHA token');
        }

        Http http = new Http();
        HttpRequest request = new HttpRequest();



        request.setEndpoint('callout:Recaptcha_NC/recaptcha/api/siteverify');
        request.setMethod('POST');
        request.setHeader('Content-Type', 'application/x-www-form-urlencoded');


        String secretKey = '6Lcbh9orAAAAABeXqP8kBpD5TB_5ttqcTLyXTjvV';

        // Build POST body
        String body = 'secret=' + EncodingUtil.urlEncode(secretKey, 'UTF-8') +
                      '&response=' + EncodingUtil.urlEncode(token, 'UTF-8');
        request.setBody(body);

        HttpResponse response = http.send(request);


        if (response.getStatusCode() != 200) {
            throw new AuraHandledException('ReCAPTCHA callout failed: ' + response.getStatus());
        }

        // Parse and return JSON body
        Map<String, Object> result = (Map<String, Object>) JSON.deserializeUntyped(response.getBody());




        return result;
    }
}